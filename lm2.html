<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LLM 설정 및 채팅 UI</title>
  <style>
      body {
    margin: 0;
    padding: 0;
    background-color: #ffffff;
    font-family: Arial, sans-serif;
  }
    :root{
      --bg:#ffffff;
      --muted:#8b8b95;
      --accent:#0066ff;
      --card:#f5f7fa;
      --glass: rgba(10,12,20,0.03);
      --shadow: 0 6px 18px rgba(20,20,30,0.06);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#fbfdff,#ffffff);color:#111}
    .app{display:flex;height:100vh;gap:24px;padding:20px;align-items:flex-start}
    /* 좌측 고정 너비 영역 */
    .left{width:370px;min-width:370px;max-width:370px;background:var(--card);border-radius:18px;padding:18px;box-shadow:var(--shadow);display:flex;flex-direction:column;height:calc(100vh - 40px);position:relative}
    .left .header{display:flex;align-items:center;gap:12px}
    .left .header h3{margin:0;font-weight:600}
    .chat-window{flex:1;background:linear-gradient(180deg,#f8f9fb,#f6f7fb);margin-top:12px;border-radius:12px;padding:22px;overflow:auto}
    .msg{max-width:85%;margin-bottom:12px;padding:12px 14px;border-radius:14px;box-shadow:0 4px 12px rgba(16,20,30,0.03)}
    .msg.user{margin-left:auto;background:#fff;border:1px solid rgba(0,0,0,0.03)}
    .msg.bot{background:linear-gradient(180deg,#ffffff,#fbfdff);border:1px solid rgba(0,0,0,0.03)}
    .input-row{display:flex;gap:12px;align-items:center;margin-top:12px}
    .input{flex:1;background:#fff;border-radius:30px;padding:14px 18px;border:1px solid rgba(0,0,0,0.04);display:flex;align-items:center;gap:12px}
    .input input{border:0;outline:0;font-size:15px;flex:1;background:transparent}
    .btn-send{width:42px;height:42px;border-radius:50%;display:inline-grid;place-items:center;border:0;background:linear-gradient(180deg,var(--accent),#0051d1);color:#fff;box-shadow:0 6px 18px rgba(0,86,255,0.12);cursor:pointer}
    .small-btn{padding:6px 10px;border-radius:10px;border:0;background:#2b2b2b;color:#fff;font-size:13px}

    /* 우측 영역 */
    .right{flex:1;background:transparent;height:calc(100vh - 40px);display:flex;flex-direction:column}
    .panel{background:var(--card);border-radius:16px;padding:18px;box-shadow:var(--shadow);height:100%;display:flex;flex-direction:column}
    .tabs{display:flex;gap:8px;border-bottom:1px solid rgba(0,0,0,0.04);padding-bottom:12px;margin-bottom:12px}
    .tab{padding:8px 14px;border-radius:10px;cursor:pointer;font-weight:600}
    .tab.active{background:#fff;box-shadow:0 6px 18px rgba(16,20,30,0.04)}
    .tab-content{flex:1;overflow:auto;padding-right:8px}

    label{display:block;font-weight:600;margin-bottom:6px}
    input[type=text], input[type=password], textarea, select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:#fff;font-size:14px}
    textarea{min-height:120px;resize:vertical}
    .form-row{margin-bottom:12px}
    .row{display:flex;gap:12px}
    .row > *{flex:1}
    .save-row{display:flex;gap:12px;align-items:center;margin-top:12px}
    .btn-primary{padding:10px 14px;border-radius:12px;border:0;background:var(--accent);color:white;cursor:pointer}
    .hint{font-size:13px;color:var(--muted);margin-top:6px}

    /* 토큰화 탭 */
    .tokens{display:flex;gap:12px}
    .token-list{flex:1;background:#fff;padding:12px;border-radius:12px;border:1px solid rgba(0,0,0,0.03);max-height:320px;overflow:auto}
    .vector-list{flex:2;background:#fff;padding:12px;border-radius:12px;border:1px solid rgba(0,0,0,0.03);max-height:320px;overflow:auto}
    .meta{margin-top:12px;display:flex;gap:12px}
    .meta .card{flex:1;background:#fff;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.03)}

    /* sliders */
    .param{margin-bottom:18px}
    .param input[type=range]{width:80%}
    .param .desc{font-size:13px;color:var(--muted);margin-top:6px}

    /* prompt engineering */
    .prompt-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .preview-btn{padding:8px 12px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:#fff;cursor:pointer}

    /* toggle button */
    .toggle-btn{position:fixed;top:20px;right:20px;z-index:2000;padding:10px 14px;border-radius:12px;background:#2b2b2b;color:#fff;border:0;box-shadow:0 6px 18px rgba(0,0,0,0.12);cursor:pointer}

    /* center when collapsed */
    .collapsed{justify-content:center}
    .collapsed .right{display:none}

    /* popup */
    .popup{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#fff;padding:18px;border-radius:12px;box-shadow:0 12px 40px rgba(12,16,28,0.2);z-index:3000;max-width:90%;max-height:80%;overflow:auto}
    .popup pre{white-space:pre-wrap;background:#f8f9fb;padding:12px;border-radius:8px}

    footer.small{font-size:13px;color:var(--muted);margin-top:18px}

    @media (max-width:900px){
      .app{padding:12px}
      .left{width:320px;min-width:320px}
    }
  </style>
</head>
<body>
  <button class="toggle-btn" id="toggleRight">LLM 설정 숨기기/표시</button>
  <div class="app" id="app">
    <div class="left">
      <div class="header"><div style="width:44px;height:44px;border-radius:10px;background:linear-gradient(180deg,#fff,#f2f4ff);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--accent)">A</div><h3>채팅</h3></div>
      <div class="chat-window" id="chatWindow"></div>
      <div style="display:flex;align-items:center;justify-content:flex-end;gap:10px;margin-top:8px">
        <button class="small-btn" id="homeBtn">Home</button>
      </div>
      <div class="input-row">
        <div class="input">
          <input id="chatInput" placeholder="메시지를 입력하세요." />
          <button class="btn-send" id="sendBtn">✈</button>
        </div>
      </div>
    </div>

    <div class="right">
      <div class="panel">
        <div class="tabs" id="tabs">
          <div class="tab" data-tab="settings">설정</div>
          <div class="tab" data-tab="tok">토큰화 & 임베딩</div>
          <div class="tab" data-tab="params">파라미터 실험실</div>
          <div class="tab" data-tab="pe">프롬프트 엔지니어링</div>
        </div>
        <div class="tab-content" id="tabContent">
          <!-- settings -->
          <div class="tab-panel" data-panel="settings">
            <div class="form-row">
              <label>LLM 선택</label>
              <select id="llmSelect"><option value="chatgpt">ChatGPT (OpenAI)</option><option value="gemini">Gemini (Vertex AI)</option></select>
            </div>
            <div class="form-row">
              <label>API Key / Bearer Token</label>
              <input type="password" id="apiKey" placeholder="여기에 API Key 또는 Bearer 토큰을 입력하세요" />
              <div class="hint">ChatGPT: OpenAI API Key 입력. Gemini: Google OAuth Bearer Token (또는 서비스 계정 토큰) 및 아래 프로젝트/지역 정보를 입력하세요.</div>
            </div>
            <div class="row">
              <div>
                <label>Gemini 프로젝트 (선택)</label>
                <input type="text" id="gemProject" placeholder="예: my-gcp-project" />
              </div>
              <div>
                <label>Gemini 지역 (선택)</label>
                <input type="text" id="gemLocation" placeholder="예: us-central1" />
              </div>
            </div>
            <div class="form-row">
              <label>System Prompt (최대 2000자)</label>
              <textarea id="systemPrompt" maxlength="2000" placeholder="시스템 프롬프트를 입력하세요"></textarea>
            </div>
            <div class="save-row">
              <button class="btn-primary" id="saveSettings">저장</button>
              <div class="hint">설정은 로컬에 저장됩니다. (브라우저 스토리지)</div>
            </div>
            <footer class="small">설정 탭이 기본 화면입니다.</footer>
          </div>

          <!-- tokenization & embeddings -->
          <div class="tab-panel" data-panel="tok" style="display:none">
            <div class="form-row"><label>마지막 입력 문장</label><div id="lastInput" class="hint">(좌측 채팅 입력의 마지막 보낸 메시지를 기반으로 토큰화/임베딩)</div></div>
            <div class="tokens">
              <div class="token-list" id="tokenList"><strong>토큰 목록</strong><div id="tokens"></div></div>
              <div class="vector-list" id="vectorList"><strong>임베딩 벡터</strong><div id="vectors" style="margin-top:8px"></div></div>
            </div>
            <div class="meta">
              <div class="card">총 토큰<br/><strong id="totalTokens">0</strong></div>
              <div class="card">벡터(차원)<br/><strong id="vectorDim">0</strong></div>
              <div class="card">원본문자<br/><strong id="origChars">0</strong></div>
            </div>
            <div style="margin-top:12px">
              <button class="btn-primary" id="computeEmb">토큰화 & 임베딩 실행</button>
              <div class="hint" style="margin-top:8px">임베딩 요청은 선택한 LLM 및 입력된 API Key로 전송됩니다. 벡터 출력은 길 수 있으므로 스크롤 됩니다.</div>
            </div>
            <div style="margin-top:18px;background:#fff;padding:12px;border-radius:10px;border:1px solid rgba(0,0,0,0.03)">
              <strong>이해하기</strong>
              <p style="margin-top:8px;color:var(--muted)">토큰화는 AI가 텍스트를 이해하기 위한 첫 번째 단계입니다. 긴 텍스트를 '토큰'이라는 작은 의미 단위로 나누어 컴퓨터가 처리할 수 있게 만듭니다.<br/><br/>임베딩은 각 토큰을 수치 벡터(숫자의 배열)로 변환하는 과정입니다. 비슷한 의미의 단어들은 벡터 공간에서 가까운 위치에 놓이게 되어, AI가 단어 간의 의미 관계를 수학적으로 계산할 수 있습니다.</p>
            </div>
          </div>

          <!-- params -->
          <div class="tab-panel" data-panel="params" style="display:none">
            <div class="param">
              <label>Temperature <span id="tVal">0.7</span></label>
              <input type="range" id="temperature" min="0" max="1" step="0.01" value="0.7" />
              <div class="desc">출력의 무작위성 조절 (0~1)</div>
            </div>
            <div class="param">
              <label>Top_P <span id="pVal">0.9</span></label>
              <input type="range" id="topP" min="0" max="1" step="0.01" value="0.9" />
              <div class="desc">핵심 확률 질량 내에서 샘플링</div>
            </div>
            <div class="param">
              <label>Frequency Penalty <span id="fVal">0.0</span></label>
              <input type="range" id="freqPenalty" min="-2" max="2" step="0.1" value="0" />
              <div class="desc">반복되는 단어의 빈도 차단 (-2~2)</div>
            </div>
            <div class="param">
              <label>Presence Penalty <span id="prVal">0.0</span></label>
              <input type="range" id="presPenalty" min="-2" max="2" step="0.1" value="0" />
              <div class="desc">새로운 주제 도입 유도 (-2~2)</div>
            </div>
            <div class="save-row">
              <button class="btn-primary" id="saveParams">저장</button>
              <div class="hint">파라미터는 채팅 전송 시 적용됩니다.</div>
            </div>
          </div>

          <!-- prompt engineering -->
          <div class="tab-panel" data-panel="pe" style="display:none">
            <p class="hint">원하는 답변을 얻기 위해 AI에게 명확하고 효과적으로 지시하는 방법을 배워봅니다. 다양한 블록을 조합하여 최적의 프롬프트를 만드세요.</p>
            <div class="prompt-grid">
              <div>
                <label>역할/대상 지정</label>
                <input type="text" id="peRole" placeholder="예: 친절한 한국어 선생님" />
              </div>
              <div>
                <label>형식 지정</label>
                <select id="peFormat"><option>표</option><option>목록</option><option>블로그</option><option>뉴스기사</option><option>코드</option><option>요약</option><option>비교설명</option><option>Q&A</option></select>
              </div>
              <div style="grid-column:1/3">
                <label>예시(One-shot 또는 Few-shot)</label>
                <textarea id="peExamples" placeholder="예시 입력 (한 줄 또는 여러 줄)"></textarea>
              </div>
              <div>
                <label>반드시 포함할 내용</label>
                <input type="text" id="peMust" placeholder="필수 포함 내용" />
              </div>
              <div>
                <label>금지할 내용</label>
                <input type="text" id="peAvoid" placeholder="금지할 내용" />
              </div>
              <div>
                <label>출력 길이 (200자 이내)</label>
                <input type="text" id="peLen" maxlength="200" placeholder="예: 150자 내외" />
              </div>
            </div>
            <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
              <button class="btn-primary" id="savePE">저장</button>
              <button class="preview-btn" id="previewPE">프롬프트 미리보기</button>
              <div class="hint">미리보기는 현재 입력된 항목을 모두 조합하여 팝업으로 표시합니다.</div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- popup container -->
  <div id="popupRoot"></div>

  <script>
    // 기본 상태 로드/초기화
    const app = document.getElementById('app');
    const tabs = document.querySelectorAll('.tab');
    const panels = document.querySelectorAll('.tab-panel');
    const toggleBtn = document.getElementById('toggleRight');
    const chatWindow = document.getElementById('chatWindow');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const homeBtn = document.getElementById('homeBtn');
    const tabContent = document.getElementById('tabContent');

    // settings elements
    const llmSelect = document.getElementById('llmSelect');
    const apiKeyInput = document.getElementById('apiKey');
    const gemProject = document.getElementById('gemProject');
    const gemLocation = document.getElementById('gemLocation');
    const systemPrompt = document.getElementById('systemPrompt');
    const saveSettingsBtn = document.getElementById('saveSettings');

    // token elements
    const lastInputEl = document.getElementById('lastInput');
    const tokensEl = document.getElementById('tokens');
    const vectorsEl = document.getElementById('vectors');
    const totalTokensEl = document.getElementById('totalTokens');
    const vectorDimEl = document.getElementById('vectorDim');
    const origCharsEl = document.getElementById('origChars');
    const computeEmbBtn = document.getElementById('computeEmb');

    // params
    const temperature = document.getElementById('temperature');
    const topP = document.getElementById('topP');
    const freqPenalty = document.getElementById('freqPenalty');
    const presPenalty = document.getElementById('presPenalty');
    const tVal = document.getElementById('tVal');
    const pVal = document.getElementById('pVal');
    const fVal = document.getElementById('fVal');
    const prVal = document.getElementById('prVal');
    const saveParams = document.getElementById('saveParams');

    // prompt engineering
    const peRole = document.getElementById('peRole');
    const peFormat = document.getElementById('peFormat');
    const peExamples = document.getElementById('peExamples');
    const peMust = document.getElementById('peMust');
    const peAvoid = document.getElementById('peAvoid');
    const peLen = document.getElementById('peLen');
    const savePE = document.getElementById('savePE');
    const previewPE = document.getElementById('previewPE');

    // popup root
    const popupRoot = document.getElementById('popupRoot');

    // 메시지 저장
    let messages = [];

    function loadSaved(){
      try{
        const s = localStorage.getItem('llm_ui_settings');
        if(s){
          const obj = JSON.parse(s);
          if(obj.llm) llmSelect.value = obj.llm;
          if(obj.apiKey) apiKeyInput.value = obj.apiKey;
          if(obj.gemProject) gemProject.value = obj.gemProject||'';
          if(obj.gemLocation) gemLocation.value = obj.gemLocation||'';
          if(obj.systemPrompt) systemPrompt.value = obj.systemPrompt||'';
        }
        const p = localStorage.getItem('llm_ui_params');
        if(p){
          const prm = JSON.parse(p);
          temperature.value = prm.temperature||0.7; topP.value = prm.topP||0.9; freqPenalty.value = prm.freqPenalty||0; presPenalty.value = prm.presPenalty||0;
        }
        const pe = localStorage.getItem('llm_ui_pe');
        if(pe){const peo=JSON.parse(pe); peRole.value=peo.role||''; peFormat.value=peo.format||'표'; peExamples.value=peo.examples||''; peMust.value=peo.must||''; peAvoid.value=peo.avoid||''; peLen.value=peo.len||''}
      }catch(e){console.warn(e)}
      renderMessages();
    }
    loadSaved();

    // 탭 처리
    tabs.forEach(t=>t.addEventListener('click',()=>{tabs.forEach(x=>x.classList.remove('active'));t.classList.add('active');const key=t.dataset.tab;panels.forEach(p=>p.style.display=(p.dataset.panel===key?'block':'none'))}));
    // 기본 탭 설정
    document.querySelector('.tab[data-tab="settings"]').click();

    // toggle
    let collapsed=false;
    toggleBtn.addEventListener('click',()=>{
      collapsed=!collapsed; if(collapsed){app.classList.add('collapsed')}else{app.classList.remove('collapsed')}
      // toggle button always visible
    });

    // chat render
    function renderMessages(){
      chatWindow.innerHTML = '';
      messages.forEach(m=>{
        const el = document.createElement('div'); el.className='msg '+(m.role==='user'?'user':'bot'); el.innerHTML = m.content.replace(/\n/g,'<br/>'); chatWindow.appendChild(el);
      });
      chatWindow.scrollTop = chatWindow.scrollHeight;
      // update last input text shown in token tab
      const last = messages.filter(m=>m.role==='user').slice(-1)[0];
      lastInputEl.textContent = last ? last.content : '(아직 보낸 메시지가 없습니다)';
    }

    // send handler
    sendBtn.addEventListener('click',()=>{const text=chatInput.value.trim(); if(!text) return; addMessage('user',text); chatInput.value=''; sendToLLM();});
    chatInput.addEventListener('keydown',e=>{if(e.key==='Enter' && !e.shiftKey){e.preventDefault();sendBtn.click();}});
    homeBtn.addEventListener('click',()=>{addMessage('bot','안녕하세요 — 홈 액션입니다.');});

    function addMessage(role,content){messages.push({role,content}); renderMessages();}

    // LLM 호출
    async function sendToLLM(){
      const apiKey = apiKeyInput.value.trim();
      if(!apiKey){alert('API Key를 입력하세요. 설정 탭에서 입력 후 저장하세요.'); tabs.forEach(t=>t.classList.remove('active')); document.querySelector('.tab[data-tab="settings"]').classList.add('active'); panels.forEach(p=>p.style.display=(p.dataset.panel==='settings'?'block':'none')); return;}
      const llm = llmSelect.value;
      const sys = systemPrompt.value.trim();
      // prepare messages for API
      const toSend = [];
      if(sys) toSend.push({role:'system', content:sys});
      messages.forEach(m=>toSend.push({role:m.role, content:m.content}));

      addMessage('bot','(응답 대기 중...)');
      const botIndex = messages.length-1;

      try{
        let reply='';
        if(llm==='chatgpt'){
          // OpenAI Chat Completions
          const body = {
            model: 'gpt-4o-mini',
            messages: toSend,
            temperature: parseFloat(temperature.value),
            top_p: parseFloat(topP.value),
            frequency_penalty: parseFloat(freqPenalty.value),
            presence_penalty: parseFloat(presPenalty.value)
          };
          const res = await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+apiKey},body:JSON.stringify(body)});
          if(!res.ok){const txt=await res.text(); throw new Error('OpenAI API error: '+res.status+' '+txt);} 
          const j = await res.json();
          // Try various response shapes
          if(j.choices && j.choices[0] && j.choices[0].message){ reply = j.choices[0].message.content; }
          else if(j.choices && j.choices[0] && j.choices[0].text){ reply = j.choices[0].text; }
          else reply = JSON.stringify(j);
        }else{
          // Gemini via Vertex AI (예상 REST 사용)
          const project = gemProject.value.trim();
          const location = gemLocation.value.trim() || 'us-central1';

          // 사용자에게 프로젝트/위치 정보를 입력하도록 안내
          if(!project){
            const confirmUse = confirm('Gemini를 사용하려면 GCP 프로젝트 ID를 입력해야 합니다. 계속해서 브라우저에서 Bearer 토큰만으로 요청을 시도하시겠습니까? (실패 시 프록시 또는 서버를 사용하세요)');
            if(!confirmUse) throw new Error('사용자 취소');
          }

          // Vertex AI 예시 엔드포인트 (사용하는 계정/토큰에 따라 작동 여부가 다름)
          const url = project ? `https://${location}-aiplatform.googleapis.com/v1/projects/${project}/locations/${location}/publishers/google/models/text-bison@001:predict` : `https://${location}-aiplatform.googleapis.com/v1/projects/${project}/locations/${location}/publishers/google/models/text-bison@001:predict`;

          const payload = {
            instances: [{content: toSend.map(m=>m.content).join('\n')}],
            parameters: {temperature: parseFloat(temperature.value), maxOutputTokens: 1024}
          };
          const res = await fetch(url,{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+apiKey},body:JSON.stringify(payload)});
          if(!res.ok){const txt=await res.text(); throw new Error('Vertex AI API error: '+res.status+' '+txt);} 
          const j = await res.json();
          // Try to extract prediction
          if(j.predictions && j.predictions[0] && (j.predictions[0].content || j.predictions[0].text)){ reply = j.predictions[0].content || j.predictions[0].text; }
          else reply = JSON.stringify(j);
        }

        // replace last bot placeholder with real reply
        messages[messages.length-1] = {role:'bot', content: reply};
        renderMessages();
      }catch(err){
        messages[messages.length-1] = {role:'bot', content: '오류 발생: '+err.message};
        renderMessages();
        console.error(err);
      }
    }

    // 토큰화 (간단한 토크나이저)
    function simpleTokenize(text){
      if(!text) return [];
      // split on whitespace and keep punctuation as separate tokens
      const raw = text.replace(/\r/g,'').trim();
      const toks = raw.split(/(\s+|[.,!?;:\/()"'\\-])/).filter(t=>t && t.trim().length>0);
      return toks;
    }

    computeEmbBtn.addEventListener('click',async ()=>{
      const apiKey = apiKeyInput.value.trim();
      if(!apiKey){alert('API Key를 먼저 입력하세요.'); return;}
      const last = messages.filter(m=>m.role==='user').slice(-1)[0];
      const text = last ? last.content : '';
      if(!text){alert('아직 보낸 메시지가 없습니다.'); return;}

      const toks = simpleTokenize(text);
      tokensEl.innerHTML = '<ol>' + toks.map(t=>`<li>${escapeHtml(t)}</li>`).join('') + '</ol>';
      totalTokensEl.textContent = toks.length;
      origCharsEl.textContent = text.length;

      vectorsEl.innerHTML = '<div class="hint">임베딩을 요청 중입니다... (토큰 수: '+toks.length+')</div>';

      try{
        if(llmSelect.value==='chatgpt'){
          // OpenAI embeddings (batch)
          const body = {model:'text-embedding-3-small', input:toks};
          const res = await fetch('https://api.openai.com/v1/embeddings',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+apiKey},body:JSON.stringify(body)});
          if(!res.ok){const txt=await res.text(); throw new Error('OpenAI Embedding error: '+res.status+' '+txt);} 
          const j = await res.json();
          if(j.data && j.data.length){
            vectorsEl.innerHTML = '';
            let dim = j.data[0].embedding.length;
            j.data.forEach((d,i)=>{
              const div=document.createElement('div'); div.style.marginBottom='8px'; div.innerHTML = `<strong>토큰 ${i}:</strong> ${escapeHtml(toks[i])}<div style=\"font-size:12px;max-height:120px;overflow:auto;background:#f8f9fb;padding:8px;border-radius:8px;margin-top:6px\">[${d.embedding.slice(0,20).map(n=>n.toFixed(4)).join(', ')}${d.embedding.length>20? ', ...':''}]</div>`;
              vectorsEl.appendChild(div);
            });
            vectorDimEl.textContent = dim;
          }else vectorsEl.innerHTML = '<div>임베딩 결과를 찾을 수 없습니다.</div>';
        }else{
          // Gemini embedding via Vertex AI (복잡성을 감안하여 토큰 단위로 요청하거나 프로젝트 정보 필요)
          // 여기서는 간단히 전체 문장 임베딩을 요청한 뒤 토큰과 매핑하여 표시
          const project = gemProject.value.trim();
          const location = gemLocation.value.trim() || 'us-central1';
          const url = project ? `https://${location}-aiplatform.googleapis.com/v1/projects/${project}/locations/${location}/publishers/google/models/textembedding-gecko@001:embedText` : null;
          if(!url){
            vectorsEl.innerHTML = '<div class="hint">Gemini 임베딩을 사용하려면 프로젝트 정보를 입력하세요.</div>';
            return;
          }
          const payload = {instances: toks.map(t=>({content:t}))};
          const res = await fetch(url,{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+apiKey},body:JSON.stringify(payload)});
          if(!res.ok){const txt=await res.text(); throw new Error('Vertex Embedding error: '+res.status+' '+txt);} 
          const j = await res.json();
          // 예상 출력: j.predictions -> 각 벡터
          if(j.predictions && j.predictions.length){
            vectorsEl.innerHTML = '';
            const dim = j.predictions[0].embedding ? j.predictions[0].embedding.length : (j.predictions[0].length||0);
            j.predictions.forEach((p,i)=>{
              const emb = p.embedding || p || [];
              const div=document.createElement('div'); div.style.marginBottom='8px'; div.innerHTML = `<strong>토큰 ${i}:</strong> ${escapeHtml(toks[i])}<div style=\"font-size:12px;max-height:120px;overflow:auto;background:#f8f9fb;padding:8px;border-radius:8px;margin-top:6px\">[${(emb.slice?emb.slice(0,20).map(n=>Number(n).toFixed(4)).join(', '):'')}${(emb.length>20? ', ...':'')}]</div>`;
              vectorsEl.appendChild(div);
            });
            vectorDimEl.textContent = dim;
          }else vectorsEl.innerHTML = '<div>임베딩 결과를 찾을 수 없습니다.</div>';
        }
      }catch(e){vectorsEl.innerHTML = '<div style="color:#b00">임베딩 중 오류: '+escapeHtml(e.message)+'</div>'; console.error(e)}
    });

    // param UI updates
    function updateParamDisplays(){ tVal.textContent = temperature.value; pVal.textContent = topP.value; fVal.textContent = freqPenalty.value; prVal.textContent = presPenalty.value; }
    [temperature,topP,freqPenalty,presPenalty].forEach(el=>el.addEventListener('input',updateParamDisplays));
    updateParamDisplays();

    saveSettingsBtn.addEventListener('click',()=>{
      const obj = {llm:llmSelect.value, apiKey:apiKeyInput.value, gemProject:gemProject.value, gemLocation:gemLocation.value, systemPrompt:systemPrompt.value};
      localStorage.setItem('llm_ui_settings', JSON.stringify(obj));
      alert('설정이 저장되었습니다.');
    });

    saveParams.addEventListener('click',()=>{ const p={temperature:temperature.value,topP:topP.value,freqPenalty:freqPenalty.value,presPenalty:presPenalty.value}; localStorage.setItem('llm_ui_params',JSON.stringify(p)); alert('파라미터가 저장되었습니다.'); });

    savePE.addEventListener('click',()=>{ const pe={role:peRole.value,format:peFormat.value,examples:peExamples.value,must:peMust.value,avoid:peAvoid.value,len:peLen.value}; localStorage.setItem('llm_ui_pe',JSON.stringify(pe)); alert('프롬프트 엔지니어링 설정이 저장되었습니다.'); });

    previewPE.addEventListener('click',()=>{
      const parts = [];
      if(peRole.value) parts.push(`[역할] ${peRole.value}`);
      if(peFormat.value) parts.push(`[형식] ${peFormat.value}`);
      if(peExamples.value) parts.push(`[예시] ${peExamples.value}`);
      if(peMust.value) parts.push(`[포함] ${peMust.value}`);
      if(peAvoid.value) parts.push(`[금지] ${peAvoid.value}`);
      if(peLen.value) parts.push(`[길이] ${peLen.value}`);
      const preview = parts.join('\n\n');
      showPopup('프롬프트 미리보기', preview);
    });

    function showPopup(title,content){
      popupRoot.innerHTML = '';
      const p = document.createElement('div'); p.className='popup'; p.innerHTML = `<h3 style=\"margin-top:0\">${title}</h3><pre>${escapeHtml(content)}</pre><div style=\"display:flex;gap:8px;justify-content:flex-end;margin-top:12px\"><button id=\"closePopup\" class=\"btn-primary\">닫기</button></div>`;
      popupRoot.appendChild(p);
      document.getElementById('closePopup').addEventListener('click',()=>{popupRoot.innerHTML=''});
    }

    function escapeHtml(s){if(!s) return ''; return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

    // 토큰화 탭 자동으로 left의 마지막 입력 동기
    setInterval(()=>{const last = messages.filter(m=>m.role==='user').slice(-1)[0]; lastInputEl.textContent = last ? last.content : '(아직 보낸 메시지가 없습니다)';},1000);

    // 초기 예시 메시지
    if(messages.length===0){messages.push({role:'bot',content:'안녕하세요. 우측 설정에서 LLM과 API Key를 입력한 뒤 채팅을 시작하세요.'}); renderMessages();}

    // 저장/복원 등의 예외 처리
    window.addEventListener('error', (e)=>{console.error('Unhandled error', e);});
  </script>
</body>
</html>
