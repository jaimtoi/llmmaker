<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LLM 실험 UI — Chat + Settings</title>
<style>
  :root{
    --bg: #0b0b0c;
    --panel: #111214;
    --panel-2: #0f1115;
    --elev: #181a1f;
    --text: #e8eaed;
    --muted: #9aa0a6;
    --brand: #0a84ff;
    --brand-2:#64d2ff;
    --ok:#34c759;
    --warn:#ff9f0a;
    --error:#ff453a;
    --radius: 14px;
    --radius-sm: 10px;
    --shadow: 0 8px 24px rgba(0,0,0,0.35), 0 1px 0 rgba(255,255,255,0.02) inset;
    --shadow-soft: 0 6px 18px rgba(0,0,0,0.28);
    --border: 1px solid rgba(255,255,255,0.06);
    --input: #0c0d10;
    --accent: linear-gradient(135deg, #0a84ff, #64d2ff);
  }
  @media (prefers-color-scheme: light){
    :root{
      --bg:#f5f7fb; --panel:#ffffff; --panel-2:#fbfbfd; --elev:#ffffff; --text:#121212; --muted:#5f6368;
      --border: 1px solid rgba(0,0,0,0.08); --input:#f2f3f7; --shadow: 0 8px 24px rgba(0,0,0,0.06), 0 1px 0 rgba(0,0,0,0.02) inset;
      --shadow-soft:0 6px 18px rgba(0,0,0,0.06);
    }
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background: radial-gradient(1200px 1200px at 80% -10%, rgba(10,132,255,0.07), transparent 45%) , var(--bg);
    color:var(--text); font: 15px/1.5 -apple-system, BlinkMacSystemFont, "SF Pro Display","SF Pro Text","Apple SD Gothic Neo","Noto Sans KR",system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    letter-spacing:-0.2px;
  }
  .app{
    position:relative; height:100vh; width:100%; display:flex; gap:18px; padding:18px;
  }
  .left{
    width:370px; min-width:370px; max-width:370px;
    background:var(--panel); border-radius:var(--radius); box-shadow:var(--shadow); border:var(--border);
    display:flex; flex-direction:column; overflow:hidden;
  }
  .left .header{
    padding:12px 14px; border-bottom:var(--border); display:flex; align-items:center; gap:8px;
  }
  .home-chip{
    margin-left:auto; background:var(--input); color:var(--muted); padding:6px 10px; border-radius:999px; font-size:12px; border:var(--border);
  }
  .chat{
    flex:1; overflow:auto; padding:12px; background:
      radial-gradient(800px 500px at -10% 0%, rgba(100,210,255,0.06), transparent 60%),
      linear-gradient(to bottom, rgba(255,255,255,0.02), transparent 10%);
  }
  .msg{
    max-width:86%; margin:8px 0; padding:10px 12px; border-radius:14px; box-shadow:var(--shadow-soft); border:var(--border); backdrop-filter:saturate(140%) blur(2px);
  }
  .msg.user{ margin-left:auto; background:linear-gradient(180deg, rgba(10,132,255,0.16), rgba(10,132,255,0.10)); border:1px solid rgba(10,132,255,0.35);}
  .msg.ai{ background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));}
  .input-area{
    padding:12px; border-top:var(--border); background:linear-gradient(180deg, rgba(255,255,255,0.03), transparent);
    display:flex; gap:8px; align-items:center;
  }
  .input{ flex:1; position:relative }
  .input input{
    width:100%; border-radius:12px; padding:12px 44px 12px 12px; outline:none; background:var(--input); color:var(--text); border:var(--border);
  }
  .send-btn{
    position:absolute; right:6px; top:50%; transform:translateY(-50%);
    width:34px; height:34px; border-radius:10px; border:var(--border); background:var(--panel-2); cursor:pointer;
    display:grid; place-items:center; box-shadow:var(--shadow-soft);
  }
  .send-btn:hover{ background:linear-gradient(180deg, rgba(10,132,255,0.15), rgba(10,132,255,0.05)); }
  .send-btn svg{ width:18px; height:18px; fill:var(--text); opacity:.8}

  .right{
    flex:1; min-width:420px; background:var(--panel); border-radius:var(--radius); box-shadow:var(--shadow); border:var(--border);
    display:flex; flex-direction:column; overflow:hidden; position:relative;
  }
  .tabs{
    display:flex; gap:8px; padding:12px; border-bottom:var(--border); background:linear-gradient(180deg, rgba(255,255,255,0.03), transparent);
  }
  .tab{
    padding:10px 14px; border-radius:12px; background:var(--panel-2); cursor:pointer; border:var(--border);
    color:var(--muted); transition: all .2s ease; white-space:nowrap;
  }
  .tab.active{ color:var(--text); background:linear-gradient(180deg, rgba(10,132,255,0.16), rgba(10,132,255,0.08)); border-color:rgba(10,132,255,0.35)}
  .content{ flex:1; overflow:auto; padding:16px 18px 26px 18px; }
  .row{ display:flex; gap:12px; margin-bottom:12px; flex-wrap:wrap }
  .col{ flex:1; min-width:240px }
  label{ display:block; font-weight:600; margin:10px 0 6px 2px; font-size:13px; color:var(--muted)}
  input[type="text"], input[type="password"], textarea, select{
    width:100%; background:var(--input); color:var(--text); border:var(--border); border-radius:12px; padding:12px; outline:none;
  }
  textarea{ min-height:110px; resize:vertical }
  .btn{
    appearance:none; border:none; padding:12px 16px; border-radius:12px; color:white; background:var(--accent); cursor:pointer;
    box-shadow:var(--shadow-soft); transition: transform .04s ease;
  }
  .btn:active{ transform: translateY(1px) }
  .btn.ghost{ background:var(--panel-2); color:var(--text); border:var(--border) }
  .inline{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
  .note{ color:var(--muted); font-size:13px }
  .hr{ height:1px; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.12), transparent); margin:16px 0 }
  .metrics{ display:flex; gap:14px; flex-wrap:wrap; margin:12px 0 }
  .metric{
    background:var(--panel-2); border:var(--border); padding:10px 12px; border-radius:12px; color:var(--muted); font-size:13px;
  }
  .scrollbox{
    max-height:240px; overflow:auto; padding:10px; background:var(--panel-2); border:var(--border); border-radius:12px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    white-space:pre-wrap; word-break:break-word;
  }
  .slider-row{ width:80%; min-width:320px }
  input[type="range"]{ width:100% }
  .desc{ font-size:12px; color:var(--muted); margin-top:6px }
  .toast{
    position:fixed; right:20px; bottom:20px; padding:12px 14px; background:var(--elev); border:var(--border); border-radius:12px; box-shadow:var(--shadow-soft);
    display:none; z-index:1000;
  }
  .toggle-llm{
    position:fixed; right:20px; top:14px; z-index:999; padding:10px 14px; border-radius:999px; background:var(--elev); border:var(--border); color:var(--text);
    box-shadow:var(--shadow-soft); cursor:pointer; display:flex; align-items:center; gap:8px;
  }
  .toggle-llm svg{ width:16px; height:16px; fill:var(--text); opacity:.85 }

  .centered{ margin:0 auto }
  .hidden{ display:none !important }

  /* Modal */
  .modal-backdrop{
    position:fixed; inset:0; background:rgba(0,0,0,0.45); display:none; align-items:center; justify-content:center; z-index:1001;
  }
  .modal{
    width:min(880px, 92vw); max-height:80vh; overflow:auto; background:var(--panel); border:var(--border); border-radius:16px; box-shadow:var(--shadow);
    padding:18px;
  }
  .modal h3{ margin:0 0 8px }
  .modal .close{ margin-left:auto }
  .kicker{ font-size:12px; color:var(--muted); margin-bottom:10px }
  .spinner{
    width:16px; height:16px; border-radius:50%; border:3px solid rgba(255,255,255,0.2); border-top-color:#fff; animation:spin 1s linear infinite; display:inline-block; vertical-align:middle;
  }
  @keyframes spin{ to{ transform:rotate(360deg)} }
</style>
</head>
<body>
  <button id="toggleLLM" class="toggle-llm" title="2번 영역 토글">
    <svg viewBox="0 0 24 24"><path d="M3 6h18v2H3V6zm0 5h18v2H3v-2zm0 5h12v2H3v-2z"/></svg>
    <span>LLM 설정 숨기기/표시</span>
  </button>

  <div class="app" id="app">
    <!-- Left: Chat (1) -->
    <section class="left" id="leftPanel">
      <div class="header">
        <strong>Chat</strong>
        <span style="color:var(--muted); font-size:12px">1번 영역</span>
        <span class="home-chip">Home</span>
      </div>
      <div class="chat" id="chat"></div>
      <div class="input-area">
        <div class="input">
          <input id="chatInput" placeholder="메시지를 입력하세요." />
          <button class="send-btn" id="sendBtn" title="전송">
            <svg viewBox="0 0 24 24"><path d="M2 21l21-9L2 3v7l15 2-15 2z"/></svg>
          </button>
        </div>
      </div>
    </section>

    <!-- Right: Settings (2) -->
    <section class="right" id="rightPanel">
      <div class="tabs" id="tabs">
        <button class="tab active" data-tab="settings">설정</button>
        <button class="tab" data-tab="token">토큰화와 임베딩</button>
        <button class="tab" data-tab="params">파라미터 실험실</button>
        <button class="tab" data-tab="prompt">프롬프트 엔지니어링</button>
      </div>
      <div class="content">
        <!-- Settings -->
        <div id="tab-settings">
          <div class="row">
            <div class="col">
              <label>LLM 선택</label>
              <select id="llmSelect">
                <option value="openai">ChatGPT (OpenAI)</option>
                <option value="gemini">Gemini (Google)</option>
              </select>
              <div class="desc">대화 및 임베딩 제공자를 선택합니다.</div>
            </div>
            <div class="col">
              <label id="apiLabel">API Key</label>
              <input id="apiKey" type="password" placeholder="키를 입력하세요" autocomplete="off" />
              <div class="desc">키는 로컬 저장소에만 보관됩니다.</div>
            </div>
          </div>

          <label>System Prompt (최대 2000자)</label>
          <textarea id="systemPrompt" maxlength="2000" placeholder="대화의 기본 성격과 규칙을 정의하세요."></textarea>

          <div class="hr"></div>
          <div class="inline">
            <button class="btn" id="saveSettings">저장</button>
            <span class="note">기본 화면은 ‘설정’ 탭입니다.</span>
          </div>
        </div>

        <!-- Tokenization & Embedding -->
        <div id="tab-token" class="hidden">
          <div class="note">왼쪽 채팅에 입력한 마지막 문장을 기반으로 토큰화하고, 각 토큰의 임베딩을 계산합니다. 최대 50개 토큰까지만 임베딩을 요청합니다.</div>
          <div class="hr"></div>
          <label>토큰화 결과</label>
          <div id="tokenBox" class="scrollbox">아직 분석할 문장이 없습니다. 먼저 왼쪽에서 메시지를 입력해 주세요.</div>

          <label style="margin-top:14px">임베딩 벡터 결과</label>
          <div id="embedBox" class="scrollbox">토큰을 분석한 뒤 여기에 표시됩니다.</div>

          <div class="metrics">
            <div class="metric">총 토큰: <strong id="mTokens">0</strong></div>
            <div class="metric">벡터(차원): <strong id="mDim">-</strong></div>
            <div class="metric">원본문자: <strong id="mSource">-</strong></div>
          </div>

          <div class="hr"></div>
          <div class="kicker">이해하기</div>
          <div class="note">
            토큰화는 AI가 텍스트를 이해하기 위한 첫 번째 단계입니다. 긴 텍스트를 '토큰'이라는 작은 의미 단위로 나누어 컴퓨터가 처리할 수 있게 만듭니다.<br/>
            임베딩은 각 토큰을 수치 벡터(숫자의 배열)로 변환하는 과정입니다. 비슷한 의미의 단어들은 벡터 공간에서 가까운 위치에 놓이게 되어, AI가 단어 간의 의미 관계를 수학적으로 계산할 수 있습니다.
          </div>
        </div>

        <!-- Parameter Lab -->
        <div id="tab-params" class="hidden">
          <div class="slider-row">
            <label>Temperature (0~1)</label>
            <input type="range" id="p-temp" min="0" max="1" step="0.01" />
            <div class="desc">값이 높을수록 창의적인 답변, 낮을수록 결정적/일관적 답변이 나옵니다.</div>
          </div>
          <div class="slider-row">
            <label>Top_P (0~1)</label>
            <input type="range" id="p-topP" min="0" max="1" step="0.01" />
            <div class="desc">확률 질량이 Top-P 이하인 후보만 샘플링합니다. Temperature와 함께 사용합니다.</div>
          </div>
          <div class="slider-row">
            <label>Frequency Penalty (-2~2)</label>
            <input type="range" id="p-freq" min="-2" max="2" step="0.01" />
            <div class="desc">같은 단어나 구절의 반복을 줄입니다. (OpenAI에 적용)</div>
          </div>
          <div class="slider-row">
            <label>Presence Penalty (-2~2)</label>
            <input type="range" id="p-pres" min="-2" max="2" step="0.01" />
            <div class="desc">새 주제를 도입하도록 유도합니다. (OpenAI에 적용)</div>
          </div>
          <div class="hr"></div>
          <button class="btn" id="saveParams">저장</button>
        </div>

        <!-- Prompt Engineering -->
        <div id="tab-prompt" class="hidden">
          <div class="note">원하는 답변을 얻기 위해 AI에게 명확하고 효과적으로 지시하는 방법을 배워봅니다. 다양한 '블록'을 조합하여 최적의 프롬프트를 직접 만들어 보세요.</div>
          <div class="hr"></div>
          <div class="row">
            <div class="col">
              <label>■ 역할/대상 지정</label>
              <input id="pe-role" type="text" placeholder="예: 당신은 친절한 데이터 분석가입니다. 대상: 초등학생" />
            </div>
            <div class="col">
              <label>■ 형식 지정</label>
              <select id="pe-format">
                <option>표</option><option>목록</option><option>블로그</option><option>뉴스기사</option><option>코드</option><option>요약</option><option>비교설명</option><option>Q&A</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div class="col">
              <label>■ 예시 지정 — 단일 예시 (One-shot)</label>
              <textarea id="pe-one" placeholder="이 문제에 대한 훌륭한 예시 응답 1개를 적어보세요."></textarea>
            </div>
            <div class="col">
              <label>■ 예시 지정 — 복수 예시 (Few-shot)</label>
              <textarea id="pe-few" placeholder="여러 개의 예시를 줄바꿈으로 구분해 적어보세요."></textarea>
            </div>
          </div>
          <div class="row">
            <div class="col">
              <label>■ 조건 추가 — 반드시 포함할 내용</label>
              <input id="pe-must" type="text" placeholder="반드시 포함할 키워드, 구조 등" />
            </div>
            <div class="col">
              <label>■ 조건 추가 — 금지할 내용</label>
              <input id="pe-ban" type="text" placeholder="피해야 할 표현, 금지 주제 등" />
            </div>
            <div class="col">
              <label>■ 조건 추가 — 출력 길이 (200자 이내)</label>
              <input id="pe-len" type="text" placeholder="예: 150자 내외" maxlength="200" />
            </div>
          </div>
          <div class="hr"></div>
          <div class="inline">
            <button class="btn" id="savePrompt">저장</button>
            <button class="btn ghost" id="previewPrompt">프롬프트 조합 결과 미리보기</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Modal for preview -->
  <div class="modal-backdrop" id="modal">
    <div class="modal">
      <div class="inline" style="justify-content:space-between; align-items:center">
        <div>
          <div class="kicker">조합 미리보기</div>
          <h3 style="margin:0">프롬프트 결과</h3>
        </div>
        <button class="btn ghost close" id="closeModal">닫기</button>
      </div>
      <div class="hr"></div>
      <div id="modalContent" class="scrollbox"></div>
    </div>
  </div>

  <div class="toast" id="toast">저장되었습니다.</div>

<script>
  // State & helpers
  const $ = (q)=>document.querySelector(q);
  const $$ = (q)=>document.querySelectorAll(q);
  const state = {
    provider: localStorage.getItem('provider') || 'openai',
    openaiKey: localStorage.getItem('openaiKey') || '',
    geminiKey: localStorage.getItem('geminiKey') || '',
    systemPrompt: localStorage.getItem('systemPrompt') || '',
    params: JSON.parse(localStorage.getItem('params') || '{"temperature":0.7,"top_p":0.9,"frequency_penalty":0.0,"presence_penalty":0.0}'),
    chatHistory: [],
    lastUserText: '',
    pe: JSON.parse(localStorage.getItem('pe') || '{"role":"","format":"목록","one":"","few":"","must":"","ban":"","len":""}')
  };

  // UI init
  const chatEl = $('#chat');
  const chatInput = $('#chatInput');
  const sendBtn = $('#sendBtn');
  const rightPanel = $('#rightPanel');
  const leftPanel = $('#leftPanel');
  const toggleLLM = $('#toggleLLM');
  const apiKeyInput = $('#apiKey');
  const apiLabel = $('#apiLabel');
  const llmSelect = $('#llmSelect');
  const systemPromptInput = $('#systemPrompt');

  // Tabs
  const tabs = $$('#tabs .tab');
  const panes = {
    settings: $('#tab-settings'),
    token: $('#tab-token'),
    params: $('#tab-params'),
    prompt: $('#tab-prompt')
  };
  function setActiveTab(name){
    tabs.forEach(t => t.classList.toggle('active', t.dataset.tab===name));
    Object.entries(panes).forEach(([k,v])=> v.classList.toggle('hidden', k!==name));
    if(name==='token'){ refreshTokenAndEmbedding().catch(()=>{}); }
  }
  tabs.forEach(t=> t.addEventListener('click', ()=> setActiveTab(t.dataset.tab)));
  setActiveTab('settings'); // default

  // Load settings
  llmSelect.value = state.provider;
  systemPromptInput.value = state.systemPrompt;
  refreshApiFieldLabel();

  function refreshApiFieldLabel(){
    if(state.provider==='openai'){
      apiLabel.textContent = 'API Key (OpenAI)';
      apiKeyInput.placeholder = 'sk-...';
      apiKeyInput.value = state.openaiKey;
    }else{
      apiLabel.textContent = 'API Key (Gemini)';
      apiKeyInput.placeholder = 'AIza...';
      apiKeyInput.value = state.geminiKey;
    }
  }

  llmSelect.addEventListener('change', (e)=>{
    state.provider = e.target.value;
    localStorage.setItem('provider', state.provider);
    refreshApiFieldLabel();
  });

  $('#saveSettings').addEventListener('click', ()=>{
    const key = apiKeyInput.value.trim();
    state.systemPrompt = systemPromptInput.value.trim();
    localStorage.setItem('systemPrompt', state.systemPrompt);
    if(state.provider==='openai'){ state.openaiKey = key; localStorage.setItem('openaiKey', key); }
    else { state.geminiKey = key; localStorage.setItem('geminiKey', key); }
    toast('저장되었습니다.');
  });

  // Params
  const pTemp = $('#p-temp'), pTopP=$('#p-topP'), pFreq=$('#p-freq'), pPres=$('#p-pres');
  function syncParamsToUI(){
    pTemp.value = state.params.temperature;
    pTopP.value = state.params.top_p;
    pFreq.value = state.params.frequency_penalty;
    pPres.value = state.params.presence_penalty;
  }
  syncParamsToUI();
  $('#saveParams').addEventListener('click', ()=>{
    state.params = {
      temperature: +pTemp.value,
      top_p: +pTopP.value,
      frequency_penalty: +pFreq.value,
      presence_penalty: +pPres.value
    };
    localStorage.setItem('params', JSON.stringify(state.params));
    toast('저장되었습니다.');
  });

  // Prompt Engineering
  const peRole = $('#pe-role'), peFormat = $('#pe-format'), peOne = $('#pe-one'), peFew = $('#pe-few'), peMust = $('#pe-must'), peBan = $('#pe-ban'), peLen = $('#pe-len');
  function syncPEtoUI(){
    peRole.value = state.pe.role || '';
    peFormat.value = state.pe.format || '목록';
    peOne.value = state.pe.one || '';
    peFew.value = state.pe.few || '';
    peMust.value = state.pe.must || '';
    peBan.value = state.pe.ban || '';
    peLen.value = state.pe.len || '';
  }
  function readPEfromUI(){
    state.pe = { role: peRole.value.trim(), format: peFormat.value, one: peOne.value.trim(), few: peFew.value.trim(), must: peMust.value.trim(), ban: peBan.value.trim(), len: peLen.value.trim() };
  }
  syncPEtoUI();
  $('#savePrompt').addEventListener('click', ()=>{ readPEfromUI(); localStorage.setItem('pe', JSON.stringify(state.pe)); toast('저장되었습니다.'); });
  $('#previewPrompt').addEventListener('click', ()=>{
    readPEfromUI();
    const composed = composePrompt(state.pe);
    $('#modalContent').textContent = composed;
    openModal(true);
  });

  // Toggle right panel
  toggleLLM.addEventListener('click', ()=>{
    const hidden = rightPanel.classList.toggle('hidden');
    leftPanel.classList.toggle('centered', hidden);
  });

  // Chat actions
  sendBtn.addEventListener('click', ()=> sendChat());
  chatInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendChat(); } });

  function appendMsg(role, text){
    const el = document.createElement('div');
    el.className = 'msg ' + (role==='user'?'user':'ai');
    el.textContent = text;
    chatEl.appendChild(el);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  async function sendChat(){
    const text = chatInput.value.trim();
    if(!text) return;
    appendMsg('user', text);
    state.lastUserText = text;
    chatInput.value = '';

    appendMsg('ai', '생각 중... ');
    const thinkingEl = chatEl.lastElementChild;
    try{
      const reply = await callLLM(text);
      thinkingEl.textContent = reply || '(응답 없음)';
    }catch(err){
      thinkingEl.textContent = '오류: ' + (err?.message || err);
    }
  }

  async function callLLM(userText){
    if(state.provider==='openai'){
      if(!state.openaiKey) throw new Error('OpenAI API Key가 필요합니다.');
      const body = {
        model: 'gpt-4o-mini',
        messages: [
          ...(state.systemPrompt? [{ role:'system', content: state.systemPrompt }] : []),
          { role:'user', content: userText }
        ],
        temperature: state.params.temperature,
        top_p: state.params.top_p,
        frequency_penalty: state.params.frequency_penalty,
        presence_penalty: state.params.presence_penalty
      };
      const res = await fetch('https://api.openai.com/v1/chat/completions', {
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+state.openaiKey },
        body: JSON.stringify(body)
      });
      if(!res.ok){
        const t = await res.text();
        throw new Error('OpenAI 응답 오류: ' + t);
      }
      const data = await res.json();
      return data.choices?.[0]?.message?.content?.trim();
    }else{
      if(!state.geminiKey) throw new Error('Gemini API Key가 필요합니다.');
      const body = {
        contents: [
          ...(state.systemPrompt? [{ role:'user', parts:[{text: '시스템 지시사항:\n'+state.systemPrompt}] }] : []),
          { role:'user', parts:[{text: userText}] }
        ],
        generationConfig: {
          temperature: state.params.temperature,
          topP: state.params.top_p
        }
      };
      const url = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key='+encodeURIComponent(state.geminiKey);
      const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
      if(!res.ok){
        const t = await res.text();
        throw new Error('Gemini 응답 오류: ' + t);
      }
      const data = await res.json();
      const text = data?.candidates?.[0]?.content?.parts?.map(p=>p.text||'').join('').trim();
      return text;
    }
  }

  // Tokenization (approx) and Embedding
  const tokenBox = $('#tokenBox'), embedBox = $('#embedBox'), mTokens = $('#mTokens'), mDim = $('#mDim'), mSource = $('#mSource');

  function simpleTokenizer(str){
    // 안정성 보강: Segmenter가 없거나 예외가 발생하면 단순 공백 기반 분할로 폴백
    if(!str) return [];
    try{
      const seg = ('Segmenter' in Intl) ? new Intl.Segmenter('ko', { granularity:'word' }) : null;
      const words = seg ? Array.from(seg.segment(str)).map(s => s.segment) : str.split(/\s+/g);
      const tokens = [];
      for(const w of words){
        if(!w || !w.trim()) continue;
        // ⚠️ 여기에 있던 '/' 미이스케이프 문제를 고쳤습니다: '\/'
        // 또한 특수문자 분리를 안정적으로 적용
        const parts = w.split(/([.,!?;:"'(){}\[\]<>\/\\\-_=+*^%$#@`~|…])/g).filter(Boolean);
        tokens.push(...parts.filter(p=>p.trim()!==''));
      }
      return tokens;
    }catch(e){
      // 매우 드문 환경(구형 브라우저 등)을 위한 폴백
      return str.match(/\S+/g) || [];
    }
  }

  async function refreshTokenAndEmbedding(){
    const text = state.lastUserText || '';
    mSource.textContent = text || '-';
    if(!text){
      tokenBox.textContent = '아직 분석할 문장이 없습니다. 먼저 왼쪽에서 메시지를 입력해 주세요.';
      embedBox.textContent = '토큰을 분석한 뒤 여기에 표시됩니다.';
      mTokens.textContent = '0'; mDim.textContent = '-';
      return;
    }
    const tokens = simpleTokenizer(text);
    mTokens.textContent = String(tokens.length);
    tokenBox.textContent = tokens.map((t,i)=>`${i+1}. ${JSON.stringify(t)}`).join('\n');

    // Embedding per token (batch, limit 50)
    const first50 = tokens.slice(0,50);
    embedBox.textContent = '임베딩 계산 중... ';
    try{
      let vectors = [];
      if(first50.length===0){
        embedBox.textContent = '임베딩할 토큰이 없습니다.';
        mDim.textContent = '-';
        return;
      }
      if(state.provider==='openai'){
        if(!state.openaiKey) throw new Error('OpenAI API Key가 필요합니다.');
        const body = { model:'text-embedding-3-small', input: first50 };
        const res = await fetch('https://api.openai.com/v1/embeddings', {
          method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+state.openaiKey }, body: JSON.stringify(body)
        });
        if(!res.ok){
          const t = await res.text(); throw new Error('OpenAI 임베딩 오류: ' + t);
        }
        const data = await res.json();
        vectors = (data.data||[]).map(d=>d.embedding || d);
      }else{
        if(!state.geminiKey) throw new Error('Gemini API Key가 필요합니다.');
        const url = 'https://generativelanguage.googleapis.com/v1beta/models/text-embedding-004:batchEmbedContents?key='+encodeURIComponent(state.geminiKey);
        const body = {
          requests: first50.map(t=>({ content: { parts:[{ text: t }] } }))
        };
        const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
        if(!res.ok){ const t = await res.text(); throw new Error('Gemini 임베딩 오류: ' + t); }
        const data = await res.json();
        vectors = (data.embeddings||[]).map(e=>e.values || e);
      }

      const dim = vectors?.[0]?.length || '-';
      mDim.textContent = String(dim);

      // 숫자 포맷터: 숫자가 아닌 값이 나오더라도 안전하게 처리
      const formatNum = (n) => (typeof n === 'number' && isFinite(n)) ? n.toFixed(4) : (String(n).length>12 ? String(n).slice(0,12) + '...' : String(n));
      const lines = [];
      first50.forEach((tok,i)=>{
        const v = vectors[i] || [];
        const shown = Array.isArray(v) ? v.slice(0,12).map(formatNum).join(', ') : String(v);
        const dimi = Array.isArray(v) ? v.length : (v ? (v.length||String(v).length) : 0);
        lines.push(`${i+1}. "${tok}" → [${shown}${(Array.isArray(v) && v.length>12)?' …':''}] (dim=${dimi})`);
      });
      embedBox.textContent = lines.join('\n');
    }catch(err){
      // 사용자에게 친절한 에러 메시지 표시
      embedBox.textContent = '오류: ' + (err?.message || err);
      mDim.textContent = '-';
    }
  }

  // Utilities
  function toast(msg){
    const t = $('#toast'); t.textContent = msg; t.style.display='block'; setTimeout(()=> t.style.display='none', 1600);
  }
  function openModal(open){
    $('#modal').style.display = open?'flex':'none';
  }
  $('#closeModal').addEventListener('click', ()=> openModal(false));
  $('#modal').addEventListener('click', (e)=>{ if(e.target.id==='modal') openModal(false) });

  function composePrompt(pe){
    const blocks = [];
    if(pe.role) blocks.push(`[역할/대상]\n${pe.role}`);
    if(pe.format) blocks.push(`[형식]\n출력 형식: ${pe.format}`);
    if(pe.one) blocks.push(`[One-shot 예시]\n${pe.one}`);
    if(pe.few) blocks.push(`[Few-shot 예시]\n${pe.few}`);
    const conds = [];
    if(pe.must) conds.push(`반드시 포함: ${pe.must}`);
    if(pe.ban) conds.push(`금지: ${pe.ban}`);
    if(pe.len) conds.push(`출력 길이: ${pe.len}`);
    if(conds.length) blocks.push(`[조건]\n${conds.join('\n')}`);
    blocks.push(`[지침]\n- 명확하고 간결하게 작성하세요.\n- 모르는 정보는 추측하지 말고 부족한 점을 먼저 알리세요.`);
    return blocks.join('\n\n');
  }

  // Welcome tip
  appendMsg('ai', '안녕하세요! 오른쪽 “설정”에서 LLM과 키를 설정한 뒤, 아래 입력창에 메시지를 보내 보세요.');

  // Accessibility: focus on input
  setTimeout(()=> chatInput.focus(), 300);
</script>
</body>
</html>
